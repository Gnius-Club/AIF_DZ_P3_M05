<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>La Fortaleza del Equipo: Constructores de la Concordia</title>
  <meta name="description" content="SimulaciÃ³n de chat para ciudadanÃ­a digital. Fomenta empatÃ­a y respeto en lÃ­nea. Jugable offline y accesible." />
  <style>
    /* ==================== ESTILOS GENERALES ==================== */
    :root{
      --bg:#0b1020;          /* alto contraste: azul muy oscuro */
      --panel:#141a33;
      --text:#ffffff;
      --muted:#cbd5e1;
      --accent:#22d3ee;      /* cian brillante */
      --accent-2:#a78bfa;    /* lila */
      --good:#10b981;        /* verde */
      --bad:#ef4444;         /* rojo */
      --warning:#f59e0b;     /* Ã¡mbar */
      --bubble-ana:#0ea5e9;  /* azul Ana */
      --bubble-leo:#f97316;  /* naranja Leo */
      --bubble-mentor:#a78bfa;/* lila Mentora */
      --ui:#1f2937;          /* gris UI */
      --heart:#ff477e;       /* corazÃ³n */
      --focus:#fef08a;       /* amarillo foco */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#060913);
      color:var(--text); font-family:system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      font-size:18px; line-height:1.35; overflow:hidden;
    }
    button{font:inherit}
    .app{
      height:100%; display:grid; grid-template-rows:auto 1fr auto; gap:8px; padding:12px; max-width:1200px; margin:0 auto;
    }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:14px; background:linear-gradient(135deg,var(--panel),#0f1430);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    header h1{font-size:20px; margin:0}
    header .meta{font-size:14px; color:var(--muted)}

    .main{display:grid; grid-template-columns: 1.1fr 1fr; gap:12px; min-height:0}

    /* Panel Izquierdo: Chat */
    .chat{
      background:linear-gradient(180deg,#121634,#0d1230); border-radius:14px; padding:12px; display:grid; grid-template-rows: auto 1fr auto; gap:10px; min-height:0;
    }
    .chat h2{margin:0; font-size:18px}
    .log{overflow:auto; padding-right:6px; scrollbar-width:thin}
    .msg{display:flex; align-items:flex-start; gap:10px; margin:10px 0; opacity:0; transform:translateY(6px); animation:pop .45s ease forwards}
    .avatar{width:36px;height:36px;border-radius:50%; display:grid;place-items:center; font-weight:700; color:#000}
    .bubble{padding:10px 12px; border-radius:14px; max-width:85%; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .name{font-size:12px; opacity:.9; display:block; margin-bottom:2px}
    .mood{margin-left:6px; font-size:18px}
    .msg.ana .avatar{background:var(--bubble-ana)}
    .msg.leo .avatar{background:var(--bubble-leo)}
    .msg.mentor .avatar{background:var(--bubble-mentor)}
    .msg.ana .bubble{background:rgba(14,165,233,.18); border:1px solid rgba(14,165,233,.6)}
    .msg.leo .bubble{background:rgba(249,115,22,.14); border:1px solid rgba(249,115,22,.55)}
    .msg.mentor .bubble{background:rgba(167,139,250,.18); border:1px solid rgba(167,139,250,.55)}

    @keyframes pop{to{opacity:1; transform:translateY(0)}}

    /* Opciones */
    .choices{display:grid; gap:8px; grid-auto-rows:minmax(48px,auto)}
    .choice{
      background:linear-gradient(135deg,#0d142b,#0e1a3a); border:2px solid #263256; color:var(--text); border-radius:12px; padding:10px 12px; text-align:left;
      cursor:pointer; transition:transform .06s ease, border-color .2s ease, box-shadow .2s ease; outline:none;
    }
    .choice:hover, .choice:focus{transform:translateY(-1px); border-color:var(--accent); box-shadow:0 0 0 3px rgba(34,211,238,.3)}
    .choice[disabled]{opacity:.6; cursor:not-allowed}

    /* Panel Derecho: Fortaleza + Moral */
    .right{
      display:grid; grid-template-rows: auto 1fr; gap:10px; min-height:0;
    }
    .status{
      background:linear-gradient(135deg,var(--panel),#0f1333); border-radius:14px; padding:10px; display:flex; align-items:center; gap:12px; flex-wrap:wrap
    }
    .heart-wrap{position:relative; width:96px; height:96px}
    .heart{
      width:100%; height:100%; filter:drop-shadow(0 8px 18px rgba(255,71,126,.35));
    }
    .moral-num{font-weight:800; font-size:28px}
    .score{font-size:16px; color:var(--muted)}
    .tts{
      margin-left:auto; display:flex; gap:8px; align-items:center
    }
    .toggle{
      background:#0c1227; border:2px solid #293056; border-radius:10px; padding:6px 10px; cursor:pointer
    }

    .board{
      background:radial-gradient(1200px 400px at 50% 120%, rgba(34,211,238,.08), transparent 60%), linear-gradient(180deg,#091024,#0a0f22);
      border-radius:14px; position:relative; overflow:hidden; padding:10px; display:grid; grid-template-rows:auto 1fr; gap:6px; min-height:0
    }
    .board h2{margin:0; font-size:18px}
    canvas#fort{width:100%; height:100%; background:linear-gradient(180deg,#0b122a 0%, #0f172a 60%, #1f2937 60%, #111827 100%); border-radius:10px}

    footer{
      display:flex; gap:8px; align-items:center; justify-content:center; padding:8px; color:var(--muted); font-size:14px
    }

    /* DiÃ¡logo de fin */
    .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6)}
    .overlay.active{display:grid}
    .modal{background:linear-gradient(135deg,#10163a,#0e1333); border:2px solid #293056; border-radius:16px; padding:18px; max-width:680px; width:92vw; color:var(--text); box-shadow:0 20px 50px rgba(0,0,0,.5)}
    .modal h3{margin-top:0}
    .modal .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .modal .btn{background:#0c1227; border:2px solid #31407a; padding:10px 14px; border-radius:10px; cursor:pointer}

    /* Accesibilidad: foco visible */
    :focus-visible{outline:3px dashed var(--focus); outline-offset:2px}
  </style>
</head>
<body>
<div class="app" role="application" aria-label="La Fortaleza del Equipo: Constructores de la Concordia">
  <header>
    <div>
      <h1>La Fortaleza del Equipo: Constructores de la Concordia</h1>
      <div class="meta">PÃºblico: 8-9 aÃ±os Â· Tema: CiudadanÃ­a digital Â· Objetivo: EmpatÃ­a y respeto en chats</div>
    </div>
    <div class="meta">Juega con teclado: <strong>Tab</strong> y <strong>Enter</strong></div>
  </header>

  <div class="main" aria-live="polite">
    <!-- Panel Izquierdo (Chat) -->
    <section class="chat" aria-label="Chat grupal y opciones">
      <h2>Chat del Equipo</h2>
      <div id="log" class="log" role="log" aria-live="polite"></div>
      <div class="choices" id="choices" role="group" aria-label="Opciones de respuesta"></div>
    </section>

    <!-- Panel Derecho (Moral + Fortaleza) -->
    <section class="right">
      <div class="status" aria-label="Estado del equipo">
        <div class="heart-wrap" title="Medidor de Moral">
          <!-- CorazÃ³n SVG relleno dinÃ¡micamente segÃºn moral -->
          <svg class="heart" viewBox="0 0 100 90" aria-hidden="true">
            <defs>
              <clipPath id="clip">
                <path d="M50 82 L18 50 C4 36 7 17 22 11 c12-5 23 1 28 10 c5-9 16-15 28-10 c15 6 18 25 4 39 z"/>
              </clipPath>
              <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#ffd1e0"/>
                <stop offset="100%" stop-color="var(--heart)"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="100" height="90" fill="#2b314f" clip-path="url(#clip)"></rect>
            <rect id="fill" x="0" y="90" width="100" height="90" fill="url(#g)" clip-path="url(#clip)"></rect>
            <path d="M50 82 L18 50 C4 36 7 17 22 11 c12-5 23 1 28 10 c5-9 16-15 28-10 c15 6 18 25 4 39 z" stroke="#ff7aa6" stroke-width="2" fill="transparent"/>
          </svg>
        </div>
        <div>
          <div class="moral-num" id="moralNum" aria-live="polite" aria-atomic="true">Moral: 100</div>
          <div class="score" id="score">Puntos: 0</div>
        </div>
        <div class="tts" role="group" aria-label="Controles de sonido y voz">
          <button id="voiceBtn" class="toggle" aria-pressed="true" aria-label="Alternar narraciÃ³n por voz">ðŸ”Š Voz</button>
          <button id="sfxBtn" class="toggle" aria-pressed="true" aria-label="Alternar efectos de sonido">ðŸŽµ Sonidos</button>
        </div>
      </div>
      <div class="board">
        <h2>Fortaleza Digital</h2>
        <canvas id="fort" width="800" height="520" role="img" aria-label="Vista de la fortaleza digital en construcciÃ³n"></canvas>
      </div>
    </section>
  </div>

  <footer>
    <span>Hecho para educar en comunicaciÃ³n respetuosa. <strong>100% offline</strong>. CÃ³digo comentado y fÃ¡cil de extender.</span>
  </footer>
</div>

<!-- Overlay final -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-labelledby="endTitle" aria-describedby="endDesc">
    <h3 id="endTitle">Resultados de la misiÃ³n</h3>
    <p id="endDesc"></p>
    <div class="row">
      <button class="btn" id="retryBtn">Jugar de nuevo</button>
      <button class="btn" id="shareBtn">Copiar resumen</button>
    </div>
  </div>
</div>

<script>
/* =============================================================
   La Fortaleza del Equipo â€” Juego de ciudadanÃ­a digital
   - Todo en un solo archivo HTML + CSS + JS (sin librerÃ­as)
   - Chat interactivo con dilemas y respuestas
   - Medidor de moral con corazÃ³n animado y efectos de sonido
   - NarraciÃ³n por voz (speechSynthesis) de mensajes y feedback
   - Fortaleza en Canvas ligada a la moral
   - Accesible: texto â‰¥18px, alto contraste, aria-roles, teclado
   - FÃ¡cil de extender: agregar dilemas al arreglo `DILEMMAS`
   ============================================================= */

// -------------------- Estado del juego --------------------
const state = {
  moral: 100,        // moral de 0 a 100
  puntos: 0,         // puntaje total
  conflictosResueltos: 0,
  ideasValidadas: 0,
  moralHist: [100],  // historial para promedio
  voz: true,
  sfx: true,
  enTutorial: true,
  paso: 0,           // Ã­ndice del dilema actual
};

// -------------------- Datos: Dilemas ----------------------
// Para extender, agrega nuevos objetos con {id, intro, dialogo, opciones}
const DILEMMAS = [
  {
    id: 1,
    titulo: "Dilema 1: Burla por error",
    intro: "Ana cometiÃ³ un error en la torre. Leo se burla.",
    dialogo: [
      { who: 'ana', text: 'Upsâ€¦ creo que mi torre quedÃ³ chueca ðŸ˜Ÿ', mood:'ðŸ˜Ÿ' },
      { who: 'leo', text: 'Â¡Jajaja, quÃ© torpe! Ahora se caerÃ¡ todo.', mood:'ðŸ˜ ' },
    ],
    opciones: [
      { key:'A', text:'"Leo tiene razÃ³n, ten mÃ¡s cuidado."', efecto:-10, tipo:'exclusion', feedback:'err' },
      { key:'B', text:'"Â¡Leo, no seas grosero!" (con enojo)', efecto:-15, tipo:'agresion', feedback:'err' },
      { key:'C', text:'"No te preocupes, Ana. Todos aprendemos de errores. Y recordemos ser amables al hablar."', efecto:+10, tipo:'empatia', feedback:'ok' },
    ]
  },
  {
    id: 2,
    titulo: "Dilema 2: ExclusiÃ³n de idea",
    intro: "Ana propone decorar con un dragÃ³n. Leo lo rechaza por no ser lÃ³gico.",
    dialogo: [
      { who: 'ana', text: 'Â¡Decoremos con un dragÃ³n arriba! ðŸ‰', mood:'ðŸ™‚' },
      { who: 'leo', text: 'No, eso no es lÃ³gico. Mejor nada de adornos.', mood:'ðŸ˜‘' },
    ],
    opciones: [
      { key:'A', text:'Cancelar la idea de Ana.', efecto:-10, tipo:'exclusion', feedback:'err' },
      { key:'B', text:'Insistir solo con el dragÃ³n sin escuchar a Leo.', efecto:-10, tipo:'agresion', feedback:'err' },
      { key:'C', text:'Combinar ideas: "Un dragÃ³n que escupa fuego para defender la fortaleza"', efecto:+10, tipo:'empatia', feedback:'ok', validaIdea:true },
    ]
  },
  {
    id: 3,
    titulo: "Dilema 3: PresiÃ³n e insulto",
    intro: "Leo exige rapidez y Ana se molesta.",
    dialogo: [
      { who: 'leo', text: 'Â¡ApÃºrense! Si no, lo harÃ© yo solo. ðŸ˜¤', mood:'ðŸ˜¤' },
      { who: 'ana', text: 'Â¡AsÃ­ no se puede trabajar! Me hace sentir mal.', mood:'ðŸ˜ž' },
    ],
    opciones: [
      { key:'A', text:'Ignorar la molestia de Ana y seguir.', efecto:-10, tipo:'exclusion', feedback:'err' },
      { key:'B', text:'Responder con insulto a Leo.', efecto:-10, tipo:'agresion', feedback:'err' },
      { key:'C', text:'"Calma, equipo. Van muy bien. Coordinemos: Â¿cuÃ¡l es el siguiente paso?"', efecto:+10, tipo:'empatia', feedback:'ok' },
    ]
  },
];

// -------------------- Elementos de UI ---------------------
const logEl = document.getElementById('log');
const choicesEl = document.getElementById('choices');
const moralNumEl = document.getElementById('moralNum');
const scoreEl = document.getElementById('score');
const heartFill = document.getElementById('fill');
const voiceBtn = document.getElementById('voiceBtn');
const sfxBtn = document.getElementById('sfxBtn');
const overlay = document.getElementById('overlay');
const endDesc = document.getElementById('endDesc');
const retryBtn = document.getElementById('retryBtn');
const shareBtn = document.getElementById('shareBtn');

// Canvas fortaleza
const canvas = document.getElementById('fort');
const ctx = canvas.getContext('2d');
let animId;

// -------------------- Utilidades --------------------------
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function speak(text){
  if(!state.voz || !('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'es-MX';
  u.rate = 1.0; u.pitch = 1.0;
  speechSynthesis.cancel(); // evita solaparse
  speechSynthesis.speak(u);
}

// Efectos de sonido procedurales con WebAudio API
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
function beepOk(){ if(!state.sfx) return; ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(880,audioCtx.currentTime); g.gain.setValueAtTime(0.001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.25); o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.25); }
function beepErr(){ if(!state.sfx) return; ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(220,audioCtx.currentTime); g.gain.setValueAtTime(0.001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.25,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.4); o.connect(g).connect(audioCtx.destination); o.start(); o.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime+0.4); o.stop(audioCtx.currentTime+0.42); }

// Feedback visual en corazÃ³n
function heartPulse(good=true){
  const startY = parseFloat(heartFill.getAttribute('y'));
  const pulse = good ? 4 : -4;
  let t=0, d=12;
  const id = setInterval(()=>{
    t++;
    heartFill.setAttribute('y', startY + Math.sin(t/2)*pulse);
    if(t>d){ clearInterval(id); heartFill.setAttribute('y', startY); }
  },16);
}

// AnimaciÃ³n de brillo del corazÃ³n al acierto
function heartGlow(good=true){
  const el = document.querySelector('.heart');
  const orig = el.style.filter;
  el.style.filter = good ? 'drop-shadow(0 0 18px rgba(16,185,129,.9))' : 'drop-shadow(0 0 18px rgba(239,68,68,.9))';
  setTimeout(()=>{el.style.filter=orig}, 400);
}

// -------------------- Chat -------------------------------
function addMsg(who, text, mood=''){ // who: 'ana','leo','mentor'
  const div = document.createElement('div');
  div.className = `msg ${who}`;
  const av = document.createElement('div'); av.className='avatar'; av.textContent = who==='ana'?'A':(who==='leo'?'L':'M');
  const bub = document.createElement('div'); bub.className='bubble';
  const nm = document.createElement('span'); nm.className='name'; nm.textContent = who==='mentor'?'Mentora':(who==='ana'?'Ana':'Leo');
  const p = document.createElement('div'); p.textContent = text;
  const moodEl = document.createElement('span'); moodEl.className='mood'; moodEl.textContent = mood;
  bub.appendChild(nm); bub.appendChild(p);
  div.appendChild(av); div.appendChild(bub); div.appendChild(moodEl);
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
  speak((who==='mentor'?'Mentora: ':(who==='ana'?'Ana: ':'Leo: ')) + text);
}

// Presenta opciones de un dilema
function showChoices(opciones){
  choicesEl.innerHTML = '';
  opciones.forEach((opt, idx)=>{
    const btn = document.createElement('button');
    btn.className='choice';
    btn.type='button';
    btn.tabIndex=0;
    btn.setAttribute('aria-label', `OpciÃ³n ${opt.key}. ${opt.text}`);
    btn.textContent = `${opt.key}) ${opt.text}`;
    btn.addEventListener('click', ()=> choose(opt));
    choicesEl.appendChild(btn);
    if(idx===0) btn.focus();
  });
}

// Maneja elecciÃ³n
function choose(opt){
  // bloquea mÃ¡s clics
  [...choicesEl.querySelectorAll('button')].forEach(b=>b.disabled=true);

  // Ajusta moral y puntos
  const prev = state.moral;
  state.moral = clamp(state.moral + opt.effect ?? opt.efecto, 0, 100); // compatibilidad si se usa effect
  state.puntos += (opt.feedback==='ok'? 10 : -10);
  state.moralHist.push(state.moral);
  if(opt.feedback==='ok') state.conflictosResueltos++;
  if(opt.validaIdea) state.ideasValidadas++;

  updateHUD();

  // Feedback
  if(opt.feedback==='ok'){
    addMsg('mentor','Â¡Excelente intervenciÃ³n! Â¡Has unido al equipo!','ðŸ˜Š');
    heartPulse(true); heartGlow(true); beepOk();
  } else {
    addMsg('mentor','Â¡Cuidado! Esa respuesta aÃ±adiÃ³ mÃ¡s leÃ±a al fuegoâ€¦','ðŸ˜•');
    heartPulse(false); heartGlow(false); beepErr();
  }

  // Avanza al siguiente paso tras una breve pausa
  setTimeout(nextStep, 900);
}

// -------------------- HUD / Moral / Fort ------------------
function updateHUD(){
  moralNumEl.textContent = `Moral: ${state.moral}`;
  scoreEl.textContent = `Puntos: ${state.puntos}`;
  // Actualiza relleno del corazÃ³n (de abajo hacia arriba)
  const maxH = 90; // altura del viewBox
  const fillH = (state.moral/100)*maxH;
  heartFill.setAttribute('y', 90 - fillH);
  heartFill.setAttribute('height', fillH);
}

// Dibuja la fortaleza segÃºn moral: mÃ¡s bloques = mÃ¡s progreso
function drawFort(){
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // Fondo simple cielo/ suelo ya en CSS del canvas.

  // Terreno
  ctx.fillStyle = '#0a0f22';
  ctx.fillRect(0, h*0.6, w, h*0.4);

  // Estrellas 
  for(let i=0;i<60;i++){
    const x = (i*47)%w;
    const y = (i*19)% (h*0.55);
    ctx.fillStyle = 'rgba(255,255,255,'+ (0.2 + (i%5)/10) +')';
    ctx.fillRect(x, y, 2, 2);
  }

  // Progreso en bloques
  const pct = state.moral/100; // 0..1
  const cols = 8, rows = 6;
  const built = Math.round(cols*rows*pct);

  const pad = 30;
  const bw = (w - pad*2) / cols * 0.9; // ancho bloque
  const bh = (h*0.35) / rows * 0.9;   // alto bloque
  const baseY = h*0.58;

  // Plataforma
  ctx.fillStyle = '#1f2937';
  ctx.fillRect(pad*0.8, baseY+6, w-pad*1.6, 16);

  // Dibujar bloques llenos segÃºn progreso
  let count=0;
  for(let r=rows-1; r>=0; r--){
    for(let c=0; c<cols; c++){
      const x = pad + c*((w - pad*2)/cols);
      const y = baseY - r*((h*0.35)/rows);
      if(count < built){
        // bloque construido
        const grad = ctx.createLinearGradient(x,y,x+bw,y+bh);
        grad.addColorStop(0, '#243b6b');
        grad.addColorStop(1, '#3b82f6');
        ctx.fillStyle = grad;
        ctx.fillRect(x, y, bw, bh);
        // brillo
        ctx.strokeStyle = 'rgba(255,255,255,.15)';
        ctx.strokeRect(x+2, y+2, bw-4, bh-4);
      } else {
        // contorno de espacio pendiente
        ctx.strokeStyle = 'rgba(255,255,255,.08)';
        ctx.strokeRect(x, y, bw, bh);
      }
      count++;
    }
  }

  // Torre central si moral alta
  if(state.moral >= 80){
    const tw = 80, th = 140;
    const tx = w/2 - tw/2; const ty = baseY - th - 20;
    ctx.fillStyle = '#334155'; ctx.fillRect(tx, ty, tw, th);
    // bandera de celebraciÃ³n si victoria
    if(state.paso >= DILEMMAS.length){
      ctx.fillStyle='#ef4444';
      ctx.fillRect(tx+tw, ty+10, 60, 30);
      ctx.beginPath(); ctx.moveTo(tx+tw+60, ty+10); ctx.lineTo(tx+tw+60, ty+40); ctx.lineTo(tx+tw+90, ty+25); ctx.closePath(); ctx.fill();
      // asta
      ctx.fillStyle='#e5e7eb'; ctx.fillRect(tx+tw-2, ty+5, 4, 110);
    }
  }

  animId = requestAnimationFrame(drawFort);
}

// -------------------- Flujo del juego ---------------------
function startTutorial(){
  state.enTutorial = true;
  addMsg('mentor','Â¡Bienvenido, LÃ­der! Tu misiÃ³n es mantener la armonÃ­a del equipo mientras construyen la Fortaleza Digital.');
  addMsg('mentor','Este es el Medidor de Moral. Las palabras amables lo suben; las agresivas o excluyentes lo bajan.');
  addMsg('mentor','Respuestas que SUBEN moral: validar sentimientos, incluir ideas, usar empatÃ­a. Las que BAJAN: insultos, burlas y excluir.');
  speak('Cuando estÃ©s listo, elige una respuesta en cada dilema.');

  showChoices([
    {key:'âœ”', text:'Â¡Estoy listo! Comenzar la misiÃ³n', efecto:0, feedback:'ok'}
  ]);
}

function nextStep(){
  // Si estÃ¡ en tutorial, pasar al primer dilema
  if(state.enTutorial){
    state.enTutorial = false;
    choicesEl.innerHTML = '';
    runDilemma(0);
    return;
  }
  const next = state.paso + 1;
  if(next < DILEMMAS.length){
    runDilemma(next);
  } else {
    endGame();
  }
}

function runDilemma(i){
  state.paso = i;
  const d = DILEMMAS[i];
  // IntroducciÃ³n
  addMsg('mentor', d.titulo + ' â€” ' + d.intro, 'ðŸ§©');
  // DiÃ¡logo en el chat
  let delay = 0;
  d.dialogo.forEach((m, idx)=>{
    setTimeout(()=> addMsg(m.who, m.text, m.mood), delay);
    delay += 500;
  });
  // Mostrar opciones luego
  setTimeout(()=> showChoices(d.opciones), delay + 300);
}

function endGame(){
  cancelAnimationFrame(animId);
  // CondiciÃ³n de derrota si moral llegÃ³ a 0
  const moralAvg = Math.round(state.moralHist.reduce((a,b)=>a+b,0)/state.moralHist.length);
  const victoria = state.moral > 0 && moralAvg >= 60; // criterio: moral promedio decente
  const titulo = victoria? 'Â¡Proyecto completado! ðŸŽ‰' : 'ConstrucciÃ³n detenida ðŸ˜”';
  const resumen = `${titulo}\nResolviste ${state.conflictosResueltos} conflictos, validaste ${state.ideasValidadas} ideas y mantuviste la moral promedio en ${moralAvg}%.\nPuntuaciÃ³n total: ${state.puntos}.`;

  endDesc.textContent = resumen;
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');

  // Mensaje final hablado
  if(victoria){
    speak('Â¡Proyecto completado! Resolviste ' + state.conflictosResueltos + ' conflictos, validaste ' + state.ideasValidadas + ' ideas y mantuviste la moral por encima del sesenta por ciento.');
  } else {
    speak('La construcciÃ³n se detuvo. Reflexiona con la Mentora y vuelve a intentarlo.');
  }
}

function resetGame(){
  // Reinicia estado
  state.moral = 100; state.puntos = 0; state.conflictosResueltos = 0; state.ideasValidadas = 0; state.moralHist=[100]; state.enTutorial=true; state.paso=0;
  updateHUD();
  logEl.innerHTML = '';
  choicesEl.innerHTML = '';
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden','true');
  drawFort();
  startTutorial();
}

// -------------------- Controles ---------------------------
voiceBtn.addEventListener('click', ()=>{
  state.voz = !state.voz; voiceBtn.setAttribute('aria-pressed', String(state.voz)); voiceBtn.textContent = state.voz? 'ðŸ”Š Voz' : 'ðŸ”‡ Voz';
  if(!state.voz && 'speechSynthesis' in window) speechSynthesis.cancel();
});

sfxBtn.addEventListener('click', ()=>{
  state.sfx = !state.sfx; sfxBtn.setAttribute('aria-pressed', String(state.sfx)); sfxBtn.textContent = state.sfx? 'ðŸŽµ Sonidos' : 'ðŸ”• Sonidos';
});

retryBtn.addEventListener('click', resetGame);

shareBtn.addEventListener('click', ()=>{
  const moralAvg = Math.round(state.moralHist.reduce((a,b)=>a+b,0)/state.moralHist.length);
  const texto = `Â¡Proyecto completado! Resolviste ${state.conflictosResueltos} conflictos, validaste ${state.ideasValidadas} ideas y mantuviste la moral por encima del ${moralAvg}%. Puntos: ${state.puntos}.`;
  navigator.clipboard.writeText(texto).then(()=>{
    speak('Resumen copiado al portapapeles.');
    alert('Resumen copiado âœ¨');
  });
});

// Soporte teclado: Enter activa botÃ³n enfocado (ya por defecto). Aseguramos click con Enter/Espacio
window.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' || e.key===' '){
    const el = document.activeElement;
    if(el && el.classList.contains('choice')){
      el.click(); e.preventDefault();
    }
  }
});

// -------------------- Inicio ------------------------------
updateHUD();
 drawFort();
startTutorial();

</script>
</body>
</html>
